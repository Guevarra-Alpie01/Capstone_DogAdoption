{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/user_request.css' %}">

<div class="container">

    <!-- üêï REQUEST FORM -->
    <div class="card">
        <h2>üêï Request Dog Capture</h2>

        <!-- CAPTURE TYPE -->
        <div class="capture-choice">
            <button type="button" class="btn-secondary" onclick="showUpload()">üìÅ Upload Photo</button>
            <button type="button" class="btn-secondary" onclick="showCamera()">üì∑ Live Capture</button>
        </div>

        <form method="POST" enctype="multipart/form-data" class="capture-form">
            {% csrf_token %}

            <!-- üìÅ Upload Section -->
            <div id="uploadSection" style="display:none;">
                <label>Upload Photo</label>
                <input type="file" name="image" accept="image/*">
            </div>

            <!-- üì∑ Camera Section -->
            <div id="cameraSection" style="display:none;">
                <video id="video" autoplay playsinline style="width:100%; border-radius:10px;"></video>
                <button type="button" class="btn-primary" onclick="capturePhoto()">Capture Photo</button>
                <canvas id="canvas" style="display:none;"></canvas>
                <input type="hidden" name="captured_image" id="capturedImage">
            </div>

            <!-- Reason -->
            <div class="form-group">
                <label>Reason for Capture</label>
                <select name="reason" required>
                    <option value="">-- Select --</option>
                    <option value="biting">Dog is biting people</option>
                    <option value="aggressive">Dog is aggressive</option>
                    <option value="injured">Dog is injured</option>
                    <option value="sick">Dog looks sick</option>
                    <option value="stray">Stray dog</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <!-- Description -->
            <div class="form-group">
                <label>Additional Details</label>
                <textarea name="description" placeholder="Describe the dog, location, behavior..."></textarea>
            </div>

            <!-- LOCATION OPTIONS -->
            <h4>üìç Location Options</h4>

            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="getLocation()">
                    Use Exact GPS Location
                </button>
            </div>

            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            <p class="mt-2"><strong>OR</strong> type manually:</p>

            <div class="form-group">
                <input type="text" name="barangay" placeholder="Barangay">
            </div>
            <div class="form-group">
                <input type="text" name="city" placeholder="City / Municipality">
            </div>

            <button type="submit" class="btn-primary mt-3">
                Submit Request
            </button>
        </form>
    </div>


    <!-- üìã MY REQUESTS -->
    <div class="card">
        <h2>üìã My Requests</h2>

        {% for req in requests %}
            <div class="request-card {{ req.status }}">
                <div class="request-header">
                    <strong>{{ req.get_reason_display }}</strong>
                    <span class="status-badge {{ req.status }}">
                        {{ req.get_status_display }}
                    </span>
                </div>

                {% if req.status == 'accepted' %}
                    <p>
                        ‚úÖ Scheduled:
                        <strong>{{ req.scheduled_date|date:"M d, Y ‚Ä¢ h:i A" }}</strong>
                    </p>
                {% elif req.status == 'declined' %}
                    <p>‚ùå Request Declined</p>
                {% else %}
                    <p>‚è≥ Waiting for admin verification</p>
                {% endif %}

                {% if req.admin_message %}
                    <p class="admin-note">
                        <strong>Admin:</strong> {{ req.admin_message }}
                    </p>
                {% endif %}
            </div>
        {% empty %}
            <p>No requests yet.</p>
        {% endfor %}
    </div>

</div>


<script>
let stream;

// Show Upload
function showUpload() {
    document.getElementById("uploadSection").style.display = "block";
    document.getElementById("cameraSection").style.display = "none";

    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
}

// Show Camera
function showCamera() {
    document.getElementById("cameraSection").style.display = "block";
    document.getElementById("uploadSection").style.display = "none";

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(s => {
            stream = s;
            document.getElementById('video').srcObject = stream;
        })
        .catch(err => {
            alert("Camera access denied or not supported.");
        });
}

// Capture Photo
function capturePhoto() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);

    const imageData = canvas.toDataURL('image/png');
    document.getElementById('capturedImage').value = imageData;

    alert("Photo captured successfully!");
}

// Get GPS Location
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById("latitude").value = position.coords.latitude;
            document.getElementById("longitude").value = position.coords.longitude;
            alert("Location captured successfully!");
        }, function() {
            alert("Unable to retrieve location.");
        });
    } else {
        alert("Geolocation not supported.");
    }
}
</script>

{% endblock %}
