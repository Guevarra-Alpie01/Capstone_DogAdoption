{% extends 'admin_base.html' %}
{% load static %}

{% block title %}Dog Registration Records{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/registration.css' %}">

<section class="ui-page">
    <article class="ui-card">
        <div class="ui-card__header">
            <h1 class="ui-card__title">Dog Registration Records</h1>
            <p class="ui-card__subtitle">Search by barangay and review the latest records.</p>
        </div>

        <div class="ui-card__body ui-stack">
            <form method="get"
                  action="{% url 'dogadoption_admin:registration_record' %}"
                  autocomplete="off"
                  id="barangay-form"
                  class="ui-form">
                <div class="ui-field record-filter-field">
                    <label for="barangay-input" class="ui-label">Barangay Name</label>
                    <input type="text"
                           id="barangay-input"
                           name="barangay"
                           class="ui-input"
                           value="{{ selected_barangay|default:'' }}"
                           placeholder="Type barangay name..."
                           oninput="showSuggestions(this.value)">
                    <div id="suggestions" class="suggestions-box" style="display:none;"></div>
                </div>
                <button type="submit" class="ui-btn ui-btn--primary">Show Records</button>
            </form>

            {% if dogs %}
                <h2 class="h5 mb-0">Records for: <em>{{ selected_barangay|default:"All (Recent 20)" }}</em></h2>
                <div class="table-wrap">
                    <table class="records-table ui-table">
                        <thead>
                            <tr>
                                <th rowspan="2">No.</th>
                                <th rowspan="2">Date</th>
                                <th rowspan="2">Name</th>
                                <th rowspan="2">Species</th>
                                <th rowspan="2">Sex</th>
                                <th rowspan="2">Age</th>
                                <th rowspan="2">Neutering</th>
                                <th rowspan="2">Color</th>
                                <th colspan="2">Pet Owner</th>
                            </tr>
                            <tr>
                                <th>Name</th>
                                <th>Complete Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dog in dogs %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ dog.date_registered|date:"m-d-Y" }}</td>
                                    <td>{{ dog.name }}</td>
                                    <td>{{ dog.species }}</td>
                                    <td>{{ dog.sex }}</td>
                                    <td>{{ dog.age }}</td>
                                    <td>{{ dog.neutering_status }}</td>
                                    <td>{{ dog.color }}</td>
                                    <td>{{ dog.owner_name }}</td>
                                    <td>{{ dog.owner_address }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% elif selected_barangay %}
                <p class="ui-muted mb-0">No records found for barangay: <strong>{{ selected_barangay }}</strong>.</p>
            {% endif %}
        </div>
    </article>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const barangays = {{ barangay_list|safe }};
    const suggestionsBox = document.getElementById('suggestions');
    const barangayInput = document.getElementById('barangay-input');

    window.showSuggestions = function (value) {
        const input = value.toLowerCase().trim();
        if (!input) {
            suggestionsBox.style.display = 'none';
            suggestionsBox.innerHTML = '';
            return;
        }

        const filtered = barangays.filter(function (item) {
            return item.toLowerCase().startsWith(input);
        });

        if (filtered.length === 0) {
            suggestionsBox.style.display = 'none';
            suggestionsBox.innerHTML = '';
            return;
        }

        suggestionsBox.innerHTML = filtered.map(function (item) {
            var escaped = item.replace(/\"/g, '&quot;');
            return '<button type="button" class="suggestion-item" data-name=\"' + escaped + '\">' + item + '</button>';
        }).join('');
        suggestionsBox.style.display = 'block';
    };

    function selectBarangay(name) {
        barangayInput.value = name;
        suggestionsBox.style.display = 'none';
    }

    suggestionsBox.addEventListener('click', function (event) {
        var target = event.target.closest('.suggestion-item');
        if (!target) {
            return;
        }
        selectBarangay(target.getAttribute('data-name'));
    });

    document.addEventListener('click', function (event) {
        if (!barangayInput.contains(event.target) && !suggestionsBox.contains(event.target)) {
            suggestionsBox.style.display = 'none';
        }
    });
});
</script>
{% endblock %}

