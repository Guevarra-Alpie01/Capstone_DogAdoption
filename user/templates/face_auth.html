{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/face_auth.css' %}">

<div class="face-wrapper">
    <div class="face-card">

        <!-- STEP LABEL -->
        <div class="step-label" id="stepLabel">STEP 1</div>

        <!-- MAIN INSTRUCTION -->
        <h2 id="instructionTitle">Face Verification</h2>
        <p id="instructionDesc">Position your face inside the circle</p>

        <!-- CAMERA CIRCLE -->
        <div class="camera-circle">
            <video id="video" autoplay playsinline></video>
        </div>

        <!-- STATUS -->
        <p id="status"></p>

        <canvas id="canvas" style="display:none;"></canvas>

        <form id="csrf-form" style="display:none;">
            {% csrf_token %}
        </form>

        <!-- CONSENT SECTION (HIDDEN FIRST) -->
            <div id="consentSection" class="consent-box" style="display:none;">
                <h4>Terms and Conditions</h4>

                <p>
                    By proceeding with this facial verification process, you acknowledge and consent that the facial images captured will be used solely for identity verification and account security purposes within the system.
                </p>

                <p>
                    You understand that access to these facial images is strictly limited to authorized system administrators and will be handled in accordance with applicable data protection and privacy standards.
                </p>

                <p>
                    You further agree that the captured facial images will not be publicly displayed, shared, or used for any purpose outside of secure authentication and verification within the platform.
                </p>

                <label class="consent-check">
                    <input type="checkbox" id="agreeCheckbox">
                    I have read and agree to the Terms and Conditions
                </label>

                <button id="completeSignupBtn" class="btn btn-success mt-3" disabled>
                    Complete Signup
                </button>
            </div>


    </div>
</div>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const stepLabel = document.getElementById("stepLabel");
const instructionTitle = document.getElementById("instructionTitle");
const instructionDesc = document.getElementById("instructionDesc");
const statusText = document.getElementById("status");

const consentSection = document.getElementById("consentSection");
const agreeCheckbox = document.getElementById("agreeCheckbox");
const completeSignupBtn = document.getElementById("completeSignupBtn");

const csrftoken = document.querySelector(
    '#csrf-form input[name="csrfmiddlewaretoken"]'
).value;

let images = [];
let step = 0;
let lastCaptureTime = 0;
let uploadDone = false;

/* ======================
   STEP CONFIG (GCASH STYLE)
====================== */
const STEPS = [
    { key: "LOOK_FORWARD", title: "Look Straight", desc: "Align your face inside the circle" },
    { key: "TURN_LEFT", title: "Turn Left", desc: "Slowly turn your head to the LEFT" },
    { key: "TURN_RIGHT", title: "Turn Right", desc: "Slowly turn your head to the RIGHT" },
    { key: "BLINK", title: "Blink", desc: "Blink your eyes naturally" }
];

updateStepUI();

/* ======================
   UPDATE UI
====================== */
function updateStepUI(){
    stepLabel.innerText = `STEP ${step + 1}`;
    instructionTitle.innerText = STEPS[step].title;
    instructionDesc.innerText = STEPS[step].desc;
}

/* ======================
   FACE MESH INIT
====================== */
const faceMesh = new FaceMesh({
    locateFile: file =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
});

faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6
});

faceMesh.onResults(onResults);

/* ======================
   CAMERA INIT
====================== */
const camera = new Camera(video, {
    onFrame: async () => {
        await faceMesh.send({ image: video });
    },
    width: 640,
    height: 480
});
camera.start();

/* ======================
   MAIN DETECTION
====================== */
function onResults(results) {
    if (!results.multiFaceLandmarks || uploadDone) return;

    const landmarks = results.multiFaceLandmarks[0];

    if (checkStep(landmarks) && canCapture()) {
        captureImage();
        step++;

        if (step >= STEPS.length) {
            statusText.innerText = "Face verification complete!";
            uploadImages(); // upload first
        } else {
            updateStepUI();
        }
    }
}

/* ======================
   HEAD YAW
====================== */
function headYaw(landmarks) {
    const nose = landmarks[1].x;
    const leftCheek = landmarks[234].x;
    const rightCheek = landmarks[454].x;

    const faceWidth = rightCheek - leftCheek;
    const faceCenter = leftCheek + faceWidth / 2;

    return (nose - faceCenter) / faceWidth;
}

/* ======================
   STEP CHECKS
====================== */
function checkStep(landmarks) {
    const yaw = headYaw(landmarks);

    switch (STEPS[step].key) {
        case "LOOK_FORWARD":
            return Math.abs(yaw) < 0.05;
        case "TURN_LEFT":
            return yaw > 0.15;
        case "TURN_RIGHT":
            return yaw < -0.15;
        case "BLINK":
            return isBlinking(landmarks);
    }
}

function isBlinking(landmarks) {
    const top = landmarks[159].y;
    const bottom = landmarks[145].y;
    return (bottom - top) < 0.01;
}

/* ======================
   CAPTURE CONTROL
====================== */
function canCapture() {
    const now = Date.now();
    if (now - lastCaptureTime > 1200) {
        lastCaptureTime = now;
        return true;
    }
    return false;
}

/* ======================
   CAPTURE IMAGE
====================== */
function captureImage() {
    canvas.width = 480;
    canvas.height = 360;

    const ctx = canvas.getContext("2d");
    ctx.save();
    ctx.scale(-1, 1);
    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
    ctx.restore();

    const img = canvas.toDataURL("image/jpeg", 0.6);
    images.push(img);
}

/* ======================
   UPLOAD FIRST THEN SHOW CONSENT
====================== */
function uploadImages() {
    uploadDone = true;

    fetch("{% url 'user:save_face' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ images })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "ok") {
            consentSection.style.display = "block";
            statusText.innerText = "Please review and accept the consent to continue.";
        } else {
            alert("Face verification failed");
        }
    });
}

/* ======================
   ENABLE BUTTON ONLY IF CHECKED
====================== */
agreeCheckbox.addEventListener("change", function(){
    completeSignupBtn.disabled = !this.checked;
});

/* ======================
   FINAL COMPLETE SIGNUP
====================== */
completeSignupBtn.addEventListener("click", function(){
    window.location.href = "{% url 'user:signup_complete' %}";
});
</script>
{% endblock %}
