{% extends 'admin_base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/create_announcement.css' %}">

{% if request.user.is_staff %}
<div class="create-announcement-bar">
    <a href="{% url 'dogadoption_admin:announcement_create' %}" class="create-btn">â• Create Announcement</a>
</div>
{% endif %}

<div class="announcement-feed">
    {% for post in announcements %}
    <div class="card">

        <!-- ADMIN CONTROLS (inside loop!) -->
        {% if request.user.is_staff %}
        <div class="admin-controls">
            <a href="{% url 'dogadoption_admin:announcement_edit' post.id %}">âœï¸ Edit</a>
            <a href="{% url 'dogadoption_admin:announcement_delete' post.id %}" onclick="return confirm('Delete this announcement?');">ğŸ—‘ï¸ Delete</a>
        </div>
        {% endif %}

        <!-- HEADER -->
        <div class="card-header">
            <div class="avatar">ğŸ¾</div>
            <div class="meta">
                <span class="admin-name">Admin Announcement</span>
                <span class="timestamp">{{ post.created_at|timesince }} ago</span>
            </div>
        </div>

        <!-- POST CONTENT -->
        {% if post.post_type == 'IMAGE_BG' and post.background_image %}
        <div class="hero-body has-bg" style="background-image: url('{{ post.background_image.url }}');">
        {% else %}
        <div class="hero-body" style="background-color: {{ post.background_color|default:'#4f46e5' }};">
        {% endif %}
            <div class="hero-overlay">
                <h2 class="hero-text">{{ post.content }}</h2>
            </div>
        </div>

        {% if post.post_type == 'PHOTO' and post.background_image %}
        <div class="photo-body">
            <p class="caption">{{ post.content }}</p>
            <img src="{{ post.background_image.url }}" alt="Announcement Photo" class="main-photo">
        </div>
        {% endif %}

        {% if post.schedule_data %}
        <div class="schedule-section">
            <h4 class="schedule-title">ğŸ“… Dog Activity Schedule</h4>
            <div class="schedule-list">
                {% for item in post.schedule_data %}
                <div class="schedule-row">
                    <span class="time">{{ item.time }}</span>
                    <span class="task">{{ item.task }}</span>
                </div>
                {% empty %}
                <p>No activities scheduled.</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- FOOTER -->
        <div class="card-footer">

            {% if request.user.is_staff %}
            <!-- Admin: reaction summary -->
            <div class="reaction-summary" id="summary-{{ post.id }}">
                {% for key, count in post.reaction_summary.items %}
                    {% if key == "LIKE" %}ğŸ‘{% elif key == "LOVE" %}â¤ï¸{% elif key == "WOW" %}ğŸ˜®{% elif key == "SAD" %}ğŸ˜¢{% elif key == "ANGRY" %}ğŸ˜¡{% endif %} {{ count }}
                {% endfor %}
            </div>
            {% else %}
            <!-- User: interactive reactions -->
            <div class="fb-reaction" data-post="{{ post.id }}">
                <button class="fb-react-btn">{{ post.user_reaction|default:"ğŸ‘ Like" }}</button>
                <div class="reaction-bar">
                    <span data-reaction="LIKE">ğŸ‘</span>
                    <span data-reaction="LOVE">â¤ï¸</span>
                    <span data-reaction="WOW">ğŸ˜®</span>
                    <span data-reaction="SAD">ğŸ˜¢</span>
                    <span data-reaction="ANGRY">ğŸ˜¡</span>
                </div>
                <div class="reaction-summary" id="summary-{{ post.id }}">
                    {% for key, count in post.reaction_summary.items %}
                        {% if count > 0 %}
                            {% if key == "LIKE" %}ğŸ‘{% elif key == "LOVE" %}â¤ï¸{% elif key == "WOW" %}ğŸ˜®{% elif key == "SAD" %}ğŸ˜¢{% elif key == "ANGRY" %}ğŸ˜¡{% endif %} {{ count }}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- COMMENT FORM -->
            <form method="POST" action="{% url 'dogadoption_admin:announcement_comment' post.id %}">
                {% csrf_token %}
                <input type="text" name="comment" placeholder="Write a comment..." required>
                <button class="footer-btn">ğŸ’¬ Comment</button>
            </form>
        </div>

        <!-- COMMENTS -->
        <div class="comments-section">
            {% for comment in post.comments.all %}
                <p><strong>{{ comment.user.username }}</strong>: {{ comment.comment }}</p>
                {% if comment.reply %}
                    <p class="admin-reply"><strong>Admin Reply:</strong> {{ comment.reply }}</p>
                {% elif request.user.is_staff %}
                    <form method="POST" action="{% url 'dogadoption_admin:comment_reply' comment.id %}">
                        {% csrf_token %}
                        <input type="text" name="reply" placeholder="Write a reply..." required>
                        <button>â†©ï¸ Reply</button>
                    </form>
                {% endif %}
            {% empty %}
                <p>No comments yet.</p>
            {% endfor %}
        </div>

    </div> <!-- END card -->
    {% empty %}
        <p class="no-posts">No announcements yet.</p>
    {% endfor %}
</div> <!-- END announcement-feed -->

{% if not request.user.is_staff %}
<script>
document.querySelectorAll('.fb-reaction').forEach(box => {
    const postId = box.dataset.post;
    const button = box.querySelector('.fb-react-btn');
    const bar = box.querySelector('.reaction-bar');

    button.addEventListener('mouseenter', () => bar.style.opacity = 1);
    button.addEventListener('mouseleave', () => {
        if (!box.classList.contains('reaction-open')) bar.style.opacity = 0;
    });

    bar.querySelectorAll('span').forEach(emoji => {
        emoji.addEventListener('click', () => sendReaction(postId, emoji.dataset.reaction, box));
    });

    button.addEventListener('click', () => sendReaction(postId, 'LIKE', box));
});

function sendReaction(postId, reaction, box) {
    fetch(`/admin/announcements/${postId}/react/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `reaction=${reaction}`
    })
    .then(res => res.json())
    .then(data => {
        box.querySelector('.fb-react-btn').innerText = data.user_reaction || 'ğŸ‘ Like';
        box.classList.add('reaction-open');

        fetch(location.href)
        .then(r => r.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newSummary = doc.querySelector(`.fb-reaction[data-post="${postId}"] .reaction-summary`);
            box.querySelector('.reaction-summary').innerHTML = newSummary.innerHTML;
        });
    });
}
</script>
{% endif %}

{% endblock %}
